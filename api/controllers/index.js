const XLSX = require("xlsx");
const fs = require("fs-extra");
const { collection } = require("../db/index");


exports.uploadFile = async (req, res) => {
    const file = req.file;
    if (!file) {
        return res.status(400).send("No file uploaded.");
    }
    const excel = XLSX.readFile(req.file.path);
    const hoja = excel.Sheets['Lecturas'];
    var lecturas = XLSX.utils.sheet_to_json(hoja);
    if (lecturas.length === 0) {
        return res.status(500).json({ message: "nombre de la hoja incorrecto" });
    }
    for (let i = 0; i < lecturas.length; i++) {
        let pos = i + 1;
        const elemet = lecturas[i];
        elemet.ORDEN = pos;
        await collection.insertOne(elemet);
    }
    await fs.unlink(req.file.path);
    res.send("Archivo subido exitosamente.");
};

exports.getLecturas = async (req, res) => {
    const { num, rango, tipo } = req.query;
    if (!num && !rango && !tipo) {
        return res.status(400).json({ message: "Medidor o Nic son requeridos" });
    }
    const nicNum = parseInt(num);
    const r = parseInt(rango);
    const tipoNum = parseInt(tipo);

    let registroCentral = null

    if (tipoNum === 1) {
        registroCentral = await collection.findOne({ NIC: nicNum });
    }
    else if (tipoNum === 0) {
        registroCentral = await collection.findOne({ Medidor: nicNum });
    }
    if (!registroCentral) {
        return res.json({ Msg: "no encontrado" });
    }
    const anteriores = await collection.find({ ORDEN: { $lt: registroCentral.ORDEN } })
        .sort({ ORDEN: -1 })
        .limit(r)
        .toArray();
    const siguientes = await collection.find({ ORDEN: { $gt: registroCentral.ORDEN } })
        .sort({ ORDEN: 1 })
        .limit(r)
        .toArray();
    res.json({
        anteriores: anteriores.reverse(),
        central: registroCentral,
        siguientes: siguientes,
    });
};
exports.getLecturasItinereario = async (req, res) => {
       const { num, itin, tipo } = req.query;
    if (!num && !itin && !tipo) {
        return res.status(400).json({ message: "Medidor o Nic son requeridos" });
    }  

    const nicNum = parseInt(num);
    const tipoNum = parseInt(tipo);

    let registroItinereario = await collection.find({CRUCE: itin }).toArray()
    let registroCentral = null

    if (tipoNum === 1) {
        registroCentral = await collection.findOne({ NIC: nicNum });
    }
    else if (tipoNum === 0) {
        registroCentral = await collection.findOne({ Medidor: nicNum });
    }
    if (!registroCentral) {
        return res.json({ Msg: "no encontrado" });
    }
    function dividirArray(array, ordenBuscado) { // Buscar el índice del objeto que tiene el ORDEN igual al buscado

  const index = array.findIndex(item => item.ORDEN === ordenBuscado);

  // Si no se encuentra, devolver todo vacío
  if (index === -1) {
    return { arriba: [], medio: [], abajo: [] };
  }

  // Dividir en tres secciones
  const arriba = array.slice(0, index);
  const medio = [array[index]];
  const abajo = array.slice(index + 1);

  return { arriba, medio, abajo };
}
    const { arriba, medio, abajo } = dividirArray(registroItinereario, registroCentral.ORDEN);
    res.json({
        anteriores: arriba,
        central: medio,
        siguientes: abajo,
    })
}
exports.getAllLecturas = async (req, res) => {
    const page = parseInt(req.query.page) || 1; // página actual
    const limit = parseInt(req.query.limit) || 1000; // registros por página
    const skip = (page - 1) * limit;

    const data = await collection.find()
        .skip(skip)
        .limit(limit)
        .toArray();

    res.json({
        page,
        limit,
        total: await collection.countDocuments(),
        data
    });
};


function obtenerCrucesUnicos(array) {
  // Extraer los valores de la propiedad CRUCE
  const cruces = array.map(item => item.CRUCE);

  // Filtrar valores únicos con un Set
  const crucesUnicos = [...new Set(cruces)];

  return crucesUnicos;
} 

exports.getCruces = async (req, res) => {

    res.json({ cruces:  [
    "1-4",
    "1-5",
    "1-6",
    "1-10",
    "1-11",
    "1-15",
    "1-16",
    "1-20",
    "1-21",
    "1-22",
    "1-25",
    "1-30",
    "1-34",
    "1-35",
    "1-36",
    "1-40",
    "1-45",
    "1-50",
    "1-51",
    "1-55",
    "1-56",
    "1-60",
    "1-65",
    "1-66",
    "1-70",
    "1-71",
    "1-72",
    "1-75",
    "1-80",
    "1-85",
    "1-86",
    "1-90",
    "1-95",
    "1-96",
    "1-97",
    "1-100",
    "1-101",
    "1-105",
    "1-106",
    "1-108",
    "1-109",
    "1-110",
    "1-115",
    "1-120",
    "1-121",
    "1-125",
    "1-126",
    "1-130",
    "1-131",
    "1-132",
    "1-135",
    "1-136",
    "1-139",
    "1-140",
    "1-141",
    "1-142",
    "1-143",
    "1-144",
    "1-145",
    "1-146",
    "1-150",
    "1-154",
    "1-155",
    "1-156",
    "1-160",
    "1-165",
    "1-166",
    "1-170",
    "1-171",
    "1-175",
    "1-176",
    "1-179",
    "1-180",
    "1-181",
    "1-184",
    "1-185",
    "1-186",
    "1-187",
    "1-189",
    "1-190",
    "1-191",
    "1-195",
    "1-196",
    "1-197",
    "1-198",
    "1-199",
    "1-200",
    "1-205",
    "1-210",
    "1-215",
    "1-216",
    "1-220",
    "1-221",
    "1-225",
    "1-230",
    "1-234",
    "1-235",
    "1-236",
    "1-240",
    "1-245",
    "1-250",
    "1-255",
    "1-260",
    "1-261",
    "1-262",
    "1-265",
    "1-270",
    "1-275",
    "1-280",
    "1-285",
    "1-290",
    "1-295",
    "1-300",
    "1-305",
    "1-310",
    "1-315",
    "1-316",
    "1-320",
    "1-325",
    "1-326",
    "1-330",
    "1-335",
    "1-340",
    "1-350",
    "1-355",
    "1-360",
    "1-365",
    "1-370",
    "1-375",
    "1-376",
    "1-377",
    "1-378",
    "1-380",
    "1-381",
    "1-382",
    "1-383",
    "1-385",
    "1-386",
    "1-387",
    "1-388",
    "1-389",
    "1-395",
    "1-400",
    "1-405",
    "1-415",
    "1-420",
    "1-435",
    "1-440",
    "1-445",
    "1-450",
    "1-451",
    "1-455",
    "1-456",
    "1-457",
    "1-460",
    "1-465",
    "1-470",
    "1-475",
    "1-480",
    "1-485",
    "1-489",
    "1-490",
    "1-491",
    "1-492",
    "1-493",
    "1-494",
    "1-495",
    "1-496",
    "1-497",
    "1-498",
    "1-499",
    "1-500",
    "1-501",
    "1-502",
    "1-505",
    "1-506",
    "1-507",
    "1-508",
    "1-509",
    "1-510",
    "1-511",
    "1-512",
    "1-519",
    "1-520",
    "1-521",
    "1-522",
    "1-523",
    "1-524",
    "1-525",
    "1-526",
    "1-530",
    "1-535",
    "1-540",
    "1-541",
    "1-542",
    "1-545",
    "1-546",
    "1-555",
    "1-556",
    "1-560",
    "1-561",
    "1-565",
    "1-570",
    "1-575",
    "1-580",
    "1-585",
    "1-586",
    "1-590",
    "1-595",
    "1-596",
    "1-600",
    "1-601",
    "1-605",
    "1-610",
    "1-611",
    "1-615",
    "1-616",
    "1-620",
    "1-625",
    "1-630",
    "1-635",
    "1-636",
    "1-637",
    "1-638",
    "1-640",
    "1-645",
    "1-655",
    "1-660",
    "1-690",
    "1-695",
    "1-700",
    "1-705",
    "1-710",
    "1-715",
    "1-716",
    "1-722",
    "1-723",
    "1-724",
    "1-725",
    "1-726",
    "1-730",
    "1-735",
    "1-740",
    "1-745",
    "1-750",
    "1-754",
    "1-755",
    "1-756",
    "1-760",
    "1-765",
    "1-766",
    "1-770",
    "1-790",
    "1-791",
    "1-795",
    "1-800",
    "1-805",
    "1-810",
    "1-815",
    "1-816",
    "1-820",
    "1-821",
    "1-825",
    "1-826",
    "1-830",
    "1-835",
    "1-836",
    "1-840",
    "1-845",
    "1-846",
    "1-850",
    "1-855",
    "1-860",
    "1-865",
    "1-870",
    "1-871",
    "1-875",
    "1-885",
    "1-890",
    "1-891",
    "1-895",
    "1-896",
    "1-900",
    "1-905",
    "1-910",
    "1-915",
    "1-920",
    "1-925",
    "1-926",
    "1-927",
    "1-930",
    "1-931",
    "1-935",
    "1-940",
    "1-941",
    "1-945",
    "1-950",
    "1-951",
    "1-955",
    "1-960",
    "1-965",
    "1-970",
    "1-975",
    "1-980",
    "1-985",
    "1-1020",
    "1-1025",
    "1-1030",
    "1-1035",
    "1-1040",
    "1-1045",
    "1-1050",
    "1-1051",
    "1-1055",
    "1-1060",
    "1-1061",
    "1-1065",
    "1-1070",
    "1-1071",
    "1-1075",
    "1-1080",
    "1-1081",
    "1-1085",
    "1-1086",
    "1-1090",
    "1-1095",
    "1-1100",
    "1-1105",
    "1-1110",
    "1-1115",
    "1-1120",
    "1-1125",
    "1-1126",
    "1-1130",
    "1-1135",
    "1-1140",
    "1-1145",
    "1-1150",
    "1-1155",
    "1-1160",
    "1-1161",
    "1-1165",
    "1-1170",
    "1-1171",
    "1-1175",
    "1-1180",
    "1-1185",
    "1-1190",
    "1-1191",
    "1-1195",
    "1-1200",
    "1-1201",
    "1-1205",
    "1-1206",
    "1-1207",
    "2-2",
    "2-3",
    "2-4",
    "2-5",
    "2-6",
    "2-7",
    "2-8",
    "2-9",
    "2-10",
    "2-11",
    "2-12",
    "2-13",
    "2-14",
    "2-15",
    "2-16",
    "2-20",
    "2-21",
    "2-25",
    "2-26",
    "2-29",
    "2-30",
    "2-31",
    "2-32",
    "2-33",
    "2-34",
    "2-35",
    "2-36",
    "2-37",
    "2-38",
    "2-40",
    "2-45",
    "2-46",
    "2-50",
    "2-51",
    "2-54",
    "2-55",
    "2-56",
    "2-60",
    "2-64",
    "2-65",
    "2-66",
    "2-67",
    "2-68",
    "2-69",
    "2-70",
    "2-71",
    "2-72",
    "2-74",
    "2-75",
    "2-76",
    "2-77",
    "2-79",
    "2-80",
    "2-81",
    "2-82",
    "2-85",
    "2-86",
    "2-90",
    "2-91",
    "2-92",
    "2-93",
    "2-94",
    "2-95",
    "2-96",
    "2-97",
    "2-98",
    "2-99",
    "2-100",
    "2-101",
    "2-102",
    "2-103",
    "2-104",
    "2-105",
    "2-106",
    "2-107",
    "2-108",
    "2-109",
    "2-110",
    "2-111",
    "2-112",
    "2-113",
    "2-114",
    "2-115",
    "2-116",
    "2-117",
    "2-118",
    "2-119",
    "2-120",
    "2-121",
    "2-124",
    "2-125",
    "2-126",
    "2-127",
    "2-128",
    "2-129",
    "2-130",
    "2-131",
    "2-135",
    "2-136",
    "2-137",
    "2-140",
    "2-141",
    "2-145",
    "2-146",
    "2-149",
    "2-150",
    "2-151",
    "2-155",
    "2-156",
    "2-159",
    "2-160",
    "2-161",
    "2-162",
    "2-163",
    "2-164",
    "2-165",
    "2-170",
    "2-171",
    "2-172",
    "2-173",
    "2-174",
    "2-175",
    "2-176",
    "2-179",
    "2-180",
    "2-181",
    "2-182",
    "2-183",
    "2-185",
    "2-189",
    "2-190",
    "2-191",
    "2-192",
    "2-193",
    "2-194",
    "2-195",
    "2-196",
    "2-197",
    "2-198",
    "2-199",
    "2-200",
    "2-201",
    "2-202",
    "2-203",
    "2-204",
    "2-205",
    "2-206",
    "2-208",
    "2-210",
    "2-211",
    "2-212",
    "2-213",
    "2-214",
    "2-215",
    "2-216",
    "2-217",
    "2-218",
    "2-219",
    "2-220",
    "2-221",
    "2-224",
    "2-225",
    "2-226",
    "2-227",
    "2-230",
    "2-231",
    "2-232",
    "2-234",
    "2-235",
    "2-236",
    "2-237",
    "2-239",
    "2-240",
    "2-241",
    "2-242",
    "2-245",
    "2-246",
    "2-249",
    "2-250",
    "2-251",
    "2-254",
    "2-255",
    "2-260",
    "2-261",
    "2-264",
    "2-265",
    "2-266",
    "2-267",
    "2-270",
    "2-275",
    "2-280",
    "2-281",
    "2-285",
    "2-286",
    "2-290",
    "2-295",
    "2-296",
    "2-300",
    "2-305",
    "2-306",
    "2-310",
    "2-315",
    "2-316",
    "2-320",
    "2-321",
    "2-325",
    "2-326",
    "2-329",
    "2-330",
    "2-331",
    "2-332",
    "2-333",
    "2-334",
    "2-335",
    "2-339",
    "2-340",
    "2-341",
    "2-342",
    "2-343",
    "2-344",
    "2-345",
    "2-346",
    "2-347",
    "2-354",
    "2-355",
    "2-356",
    "2-357",
    "2-358",
    "2-360",
    "2-370",
    "2-375",
    "2-378",
    "2-379",
    "2-380",
    "2-385",
    "2-386",
    "2-390",
    "2-391",
    "2-395",
    "2-396",
    "2-400",
    "2-401",
    "2-405",
    "2-406",
    "2-418",
    "2-419",
    "2-420",
    "2-421",
    "2-422",
    "2-423",
    "2-424",
    "2-425",
    "2-426",
    "2-427",
    "2-430",
    "2-431",
    "2-432",
    "2-433",
    "2-434",
    "2-435",
    "2-436",
    "2-437",
    "2-438",
    "2-439",
    "2-440",
    "2-441",
    "2-442",
    "2-443",
    "2-444",
    "2-445",
    "2-446",
    "2-447",
    "2-448",
    "2-449",
    "2-450",
    "2-454",
    "2-455",
    "2-459",
    "2-460",
    "2-461",
    "2-465",
    "2-470",
    "2-471",
    "2-480",
    "2-484",
    "2-485",
    "2-486",
    "2-490",
    "2-491",
    "2-492",
    "2-494",
    "2-495",
    "2-496",
    "2-497",
    "2-499",
    "2-500",
    "2-501",
    "2-502",
    "2-503",
    "2-504",
    "2-505",
    "2-506",
    "2-507",
    "2-508",
    "2-510",
    "2-511",
    "2-512",
    "2-513",
    "2-514",
    "2-515",
    "2-516",
    "2-518",
    "2-519",
    "2-520",
    "2-521",
    "2-522",
    "2-523",
    "2-524",
    "2-565",
    "2-566",
    "2-575",
    "2-576",
    "2-577",
    "2-578",
    "2-579",
    "2-580",
    "2-585",
    "2-586",
    "2-615",
    "2-616",
    "2-620",
    "2-625",
    "2-626",
    "2-650",
    "2-651",
    "2-652",
    "2-655",
    "2-656",
    "2-657",
    "2-660",
    "2-661",
    "2-662",
    "2-663",
    "2-664",
    "2-665",
    "2-666",
    "2-690",
    "2-691",
    "2-692",
    "2-695",
    "2-700",
    "2-701",
    "2-710",
    "2-711",
    "2-720",
    "2-744",
    "2-745",
    "2-746",
    "2-747",
    "2-748",
    "2-750",
    "2-751",
    "2-752",
    "2-753",
    "2-754",
    "2-755",
    "2-756",
    "2-759",
    "2-760",
    "2-761",
    "2-762",
    "2-765",
    "2-766",
    "2-770",
    "2-771",
    "2-774",
    "2-775",
    "2-776",
    "2-780",
    "2-781",
    "2-782",
    "2-783",
    "2-784",
    "2-785",
    "2-786",
    "2-789",
    "2-790",
    "2-791",
    "2-792",
    "2-793",
    "2-794",
    "2-795",
    "2-796",
    "2-797",
    "2-798",
    "2-799",
    "2-800",
    "2-801",
    "2-802",
    "2-803",
    "2-804",
    "2-805",
    "2-806",
    "2-807",
    "2-808",
    "2-809",
    "2-810",
    "2-811",
    "2-812",
    "2-813",
    "2-814",
    "2-815",
    "2-816",
    "2-817",
    "2-818",
    "2-819",
    "2-820",
    "2-821",
    "2-822",
    "2-823",
    "2-824",
    "2-825",
    "2-826",
    "2-827",
    "2-828",
    "2-829",
    "2-830",
    "2-831",
    "2-832",
    "2-833",
    "2-835",
    "2-836",
    "2-837",
    "2-838",
    "2-839",
    "2-840",
    "2-841",
    "2-842",
    "2-845",
    "2-846",
    "2-847",
    "2-848",
    "2-849",
    "2-850",
    "2-851",
    "2-852",
    "2-855",
    "2-856",
    "2-857",
    "2-860",
    "2-861",
    "2-862",
    "2-865",
    "2-866",
    "2-867",
    "2-868",
    "2-869",
    "2-870",
    "2-871",
    "2-872",
    "2-875",
    "2-876",
    "2-877",
    "2-880",
    "2-881",
    "2-882",
    "2-885",
    "2-886",
    "2-887",
    "2-888",
    "2-889",
    "2-890",
    "2-891",
    "2-892",
    "2-893",
    "2-894",
    "2-990",
    "2-995",
    "2-996",
    "2-997",
    "2-998",
    "2-999",
    "2-1001",
    "2-1002",
    "2-1003",
    "2-1004",
    "2-1792",
    "2-1795",
    "2-6914",
    "2-6915",
    "2-6916",
    "2-6917",
    "2-6918",
    "2-6919",
    "2-6920",
    "2-6921",
    "2-6923",
    "3-51",
    "3-60",
    "3-70",
    "3-80",
    "3-85",
    "3-135",
    "3-170",
    "3-340",
    "3-341",
    "3-342",
    "3-343",
    "3-350",
    "3-351",
    "3-352",
    "3-353",
    "5-5",
    "5-10",
    "5-15",
    "5-20",
    "5-25",
    "5-40",
    "5-41",
    "5-95",
    "5-125",
    "5-126",
    "5-130",
    "5-200",
    "5-205",
    "5-215",
    "5-220",
    "5-225",
    "5-230",
    "5-235",
    "5-240",
    "5-241",
    "5-245",
    "5-246",
    "5-250",
    "5-260",
    "5-265",
    "5-270",
    "5-285",
    "5-295",
    "5-300",
    "5-360",
    "5-390",
    "5-400",
    "29-5",
    "29-10",
    "29-11",
    "29-14",
    "29-15",
    "29-16",
    "29-17",
    "29-18",
    "29-19",
    "29-20",
    "29-21",
    "29-24",
    "29-25",
    "29-26",
    "29-27",
    "29-28",
    "29-30",
    "29-35",
    "29-38",
    "29-39",
    "29-40",
    "29-41",
    "29-42",
    "29-43",
    "29-50",
    "29-51",
    "29-60",
    "29-70",
    "60-1",
    "60-2",
    "60-3",
    "60-4"
  ]
});
}
